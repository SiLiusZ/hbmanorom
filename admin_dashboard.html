<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Opun+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Opun Sans', sans-serif;
            background-color: #f4f6f9;
        }
        .container-fluid {
            padding: 20px;
        }
        .summary-card {
            border-left: 5px solid;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-1 { border-left-color: #198754; background-color: #d1e7dd; }
        .card-2 { border-left-color: #dc3545; background-color: #f8d7da; }
        .card-3 { border-left-color: #ffc107; background-color: #fff3cd; }
        .card-4 { border-left-color: #0dcaf0; background-color: #cff4fc; }
        
        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
        .badge-status {
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <header class="mb-4 d-flex justify-content-between align-items-center">
        <h1 class="display-5 text-primary fw-bold">üìä ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin Dashboard)</h1>
        <button id="download-button" class="btn btn-lg btn-success" onclick="downloadAllSubmissions(this)">
            ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (CSV)
        </button>
    </header>

    <p class="lead">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</p>

    <div class="row" id="summary-cards">
        <div class="col-md-3">
            <div class="summary-card card-1">
                <h5 class="text-success">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1: Policy Maker</h5>
                <h2 class="fw-bold" id="count-group-1">0</h2>
                <p class="mb-0 text-success">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-2">
                <h5 class="text-danger">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2: Data Management</h5>
                <h2 class="fw-bold" id="count-group-2">0</h2>
                <p class="mb-0 text-danger">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-3">
                <h5 class="text-warning">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3: HCW & Med. Rec.</h5>
                <h2 class="fw-bold" id="count-group-3">0</h2>
                <p class="mb-0 text-warning">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-4">
                <h5 class="text-info">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 4: Laboratory</h5>
                <h2 class="fw-bold" id="count-group-4">0</h2>
                <p class="mb-0 text-info">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
        </div>
    </div>
    
    <hr>
    
    <h2 class="mt-4 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Latest Submissions)</h2>
    <div class="table-responsive bg-white p-3 rounded shadow-sm">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö</th>
                    <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö Q1 (‡∏¢‡πà‡∏≠)</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                <tr class="text-muted">
                    <td colspan="6" class="text-center">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <footer class="text-center mt-5 p-3 border-top">
        <p class="text-muted small">&copy; 2025 Admin Control Panel</p>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>

<script>
    // 1. Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDg9BwsZQluFZM06IESIGUj8UaOuV58U3M",
      authDomain: "hbmanorom.firebaseapp.com",
      projectId: "hbmanorom",
      storageBucket: "hbmanorom.firebasestorage.app",
      messagingSenderId: "153859735466",
      appId: "1:153859735466:web:bb4e9371d656fac224f5d3",
      measurementId: "G-ES6N7PFD1D"
    };

    // 2. Initialize Firebase ‡πÅ‡∏•‡∏∞ Firestore
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // -----------------------------------------------------------
    // ********** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Export CSV) **********
    // -----------------------------------------------------------

    /**
     * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
     * @param {HTMLElement} buttonElement - ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
     */
    async function downloadAllSubmissions(buttonElement) {
        buttonElement.disabled = true;
        const originalText = buttonElement.textContent;
        buttonElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const snapshot = await db.collection("submissions").get();
            const allDocs = [];
            let allKeys = new Set(['ID', 'group', 'timestamp']); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô

            snapshot.forEach(doc => {
                const data = doc.data();
                // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° Keys ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                Object.keys(data).forEach(key => allKeys.add(key));
                // 2. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                allDocs.push({ ID: doc.id, ...data });
            });

            if (allDocs.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                return;
            }

            // 3. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV
            const csv = convertToCsv(allDocs, Array.from(allKeys));
            
            // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
            const filename = `submissions_${new Date().toISOString().slice(0, 10)}.csv`;
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); // \ufeff ‡∏Ñ‡∏∑‡∏≠ BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel ‡πÑ‡∏ó‡∏¢
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${allDocs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

        } catch (error) {
            console.error("Error during data export:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: " + error.message);
        } finally {
            buttonElement.textContent = originalText;
            buttonElement.disabled = false;
        }
    }

    /**
     * Helper function: ‡πÅ‡∏õ‡∏•‡∏á Array of Objects ‡πÄ‡∏õ‡πá‡∏ô CSV string
     * @param {Array<Object>} objArray - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
     * @param {Array<string>} headers - ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Keys)
     */
    function convertToCsv(objArray, headers) {
        let csv = '';
        const escapeCsv = (val) => {
            if (val === null || val === undefined) return '';
            let str = String(val);
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Timestamp ‡πÅ‡∏•‡∏∞ Object/Array
            if (val instanceof firebase.firestore.Timestamp) {
                return val.toDate().toLocaleString('th-TH');
            }
            if (typeof val === 'object' && val !== null) {
                 return JSON.stringify(val).replace(/"/g, '""'); // ‡πÅ‡∏õ‡∏•‡∏á Object/Array ‡πÄ‡∏õ‡πá‡∏ô String ‡πÅ‡∏•‡πâ‡∏ß Escape Quotes
            }
            // Escape Quotes ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà Double Quotes ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ comma ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                str = '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        };

        // 1. ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header Row)
        csv += headers.map(h => escapeCsv(h)).join(',') + '\n';

        // 2. ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Rows)
        objArray.forEach(obj => {
            const row = headers.map(header => {
                let value = obj[header];
                return escapeCsv(value);
            }).join(',');
            csv += row + '\n';
        });

        return csv;
    }


    // -----------------------------------------------------------
    // ********** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard (‡πÄ‡∏î‡∏¥‡∏°) **********
    // -----------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('data-table-body');
        
        db.collection("submissions").orderBy("timestamp", "desc").onSnapshot(snapshot => {
            
            tableBody.innerHTML = ''; 
            const counts = { 'Policy Maker': 0, 'Data Management': 0, 'Health Care Worker': 0, 'Laboratory': 0 };

            snapshot.forEach(doc => {
                const data = doc.data();
                const docId = doc.id;

                // 1. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
                if (counts.hasOwnProperty(data.group)) {
                    counts[data.group]++;
                }

                // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const row = tableBody.insertRow();
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°
                let badgeClass = '';
                if (data.group === 'Policy Maker') badgeClass = 'bg-success';
                else if (data.group === 'Data Management') badgeClass = 'bg-danger';
                else if (data.group === 'Health Care Worker') badgeClass = 'bg-warning text-dark';
                else if (data.group === 'Laboratory') badgeClass = 'bg-info';

                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                const date = data.timestamp ? data.timestamp.toDate().toLocaleString('th-TH') : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                
                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏£‡∏Å (q1_1) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏¢‡πà‡∏≠
                const q1_snippet = data.q1_1 ? data.q1_1.substring(0, 30) + '...' : 'N/A';

                row.innerHTML = `
                    <td>${docId.substring(0, 5)}...</td>
                    <td><span class="badge ${badgeClass} badge-status">${data.group}</span></td>
                    <td>${q1_snippet}</td>
                    <td>${date}</td>
                    <td><span class="badge bg-success">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span></td>
                    <td><button class="btn btn-sm btn-outline-primary" 
                        onclick="window.location.href='submission_detail.html?id=' + '${docId}'">
                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button></td>
                `;
            });
            
            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ
            document.getElementById('count-group-1').textContent = counts['Policy Maker'];
            document.getElementById('count-group-2').textContent = counts['Data Management'];
            document.getElementById('count-group-3').textContent = counts['Health Care Worker'];
            document.getElementById('count-group-4').textContent = counts['Laboratory'];

            if (snapshot.size === 0) {
                 tableBody.innerHTML = '<tr class="text-muted"><td colspan="6" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore.</td></tr>';
            }
        });
    });
</script>
</body>
</html>